name: Sync Wiki to Docs (PR-based)

on:
  # Manual only to avoid org policy blocking PR creation
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clone Wiki repository
        run: |
          # If the wiki repo does not exist (wiki disabled) gracefully exit
          set -e
          git ls-remote "https://github.com/${{ github.repository }}.wiki.git" >/dev/null 2>&1 || { echo "No wiki repository found for ${GITHUB_REPOSITORY}; skipping sync."; exit 0; }
          git clone --depth 1 "https://github.com/${{ github.repository }}.wiki.git" wiki-repo

      - name: Copy Wiki content to docs
        run: |
          mkdir -p docs
          cp wiki-repo/*.md docs/ || true
          # Rename Home.md to be included in navigation
          if [ -f "docs/Home.md" ]; then
            mv docs/Home.md docs/wiki-home.md
          fi

      - name: Transform Wiki links for Pages
        run: |
          set -e
          cd docs
          shopt -s nullglob
          for file in *.md; do
            [ -f "$file" ] || continue
            # Replace Wiki-style links [Text](PageName) -> [Text](PageName.md)
            sed -i -E 's/\]\(([A-Za-z0-9_-]+)\)([^.)]|$)/](\1.md)\2/g' "$file"
            # Handle cases ending with a period
            sed -i -E 's/\]\(([A-Za-z0-9_-]+)\)\./](\1.md)./g' "$file"
            # Fix Home.md references to wiki-home.md
            sed -i 's/\[Home\](Home\.md)/[Home](wiki-home.md)/g' "$file"
          done

      - name: Remove temporary wiki clone directory
        run: |
          rm -rf wiki-repo || true

      - name: Update docs index with Wiki links
        run: |
          cat > docs/index.md << 'EOF'
          # Pact Community Organization

          Welcome. This is the official GitHub Pages site for our community foundation.

          ## Mission
          Make it easy and safe for businesses to start building with Pact.

          ## Vision
          A trusted Pact ecosystem where businesses can confidently start using audited, reliable open source Pact contracts.

          ## Wiki Content
          - [Home](wiki-home.md)
          - [About](About.md)
          - [Contribute](Contribute.md)
          - [Code of Conduct](Code-of-Conduct.md)
          - [Roadmap](Roadmap.md)
          - [Contact / Community](Contact.md)

          ## Resources
          - [GitHub Repository](https://github.com/${GITHUB_REPOSITORY_OWNER}/${GITHUB_REPOSITORY##*/})
          - [Wiki](https://github.com/${GITHUB_REPOSITORY_OWNER}/${GITHUB_REPOSITORY##*/}/wiki)
          - [Discussions](https://github.com/${GITHUB_REPOSITORY_OWNER}/${GITHUB_REPOSITORY##*/}/discussions)
          EOF

      - name: Commit changes (no push)
        run: |
          git add docs/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Sync Wiki content to Pages [automated]"

      - name: Create pull request for synced docs
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Sync Wiki content to Pages [automated]"
          title: "chore: Sync Wiki → Pages (automated)"
          body: |
            This automated PR syncs Wiki content into `docs/` and updates the site index.

            - Copies all wiki `*.md` files into `docs/`
            - Renames `Home.md` to `wiki-home.md`
            - Transforms internal wiki links to `.md` files and maps Home → `wiki-home.md`
            - Rebuilds `docs/index.md` including Contact and updated Vision

            Merging this PR will publish the latest wiki content to GitHub Pages.
          branch: bot/wiki-sync
          base: main
          labels: documentation, automation
          delete-branch: true
          
